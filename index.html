<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <!-- �������� ��� viewport ��� iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        /* �������� ����� � ������ SAFE AREA iOS */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #231F20;
            display: flex;
            justify-content: center;
            align-items: center;
            /* ���� ���������� ������� */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
        }
        
        /* ��������� ��� UNITY */
        #unity-container {
            position: relative;
            background: #000000;
            /* ������������� ����������� ������ 9:16 ��� ������������ ���� */
            width: calc(100vh * (9 / 16));
            height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* CANVAS UNITY */
        #unity-canvas {
            background: #000000;
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }
        
        /* ��������� ��� ����� ������� */
        @media (max-aspect-ratio: 9/16) {
            #unity-container {
                width: 100vw;
                height: calc(100vw * (16 / 9));
            }
        }
        
        /* ����������� ���������� */
        @media (orientation: landscape) and (max-height: 768px) {
            #unity-container {
                width: 100vw;
                height: 100vh;
            }
        }
    </style>
    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- ��������� ��� ���� -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1080 height=1920 tabindex="-1"></canvas>
        <!-- ����� �������� -->
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <!-- ������ ��� ������ -->
        <div id="unity-warning"></div>
    </div>

    <!-- ���������� ������ ���������� Unity -->
    <script src="Build/WebGL_Build.loader.js"></script>

    <script>
        // ========== TELEGRAM MINI APP ������������� ==========
        document.addEventListener('DOMContentLoaded', function() {
            // ������������� Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                const tg = Telegram.WebApp;
                
                // 1. ������������ �������������
                tg.ready();
                console.log('Telegram WebApp initialized.');
                
                // 2. ��������� ����������
                // ��������� ������ ��� �������
                if (typeof tg.disableVerticalSwipes === 'function') {
                    tg.disableVerticalSwipes();
                }
                
                // 3. ��������� �������������� ������ (����� ���������� �������)
                setTimeout(function() {
                    try {
                        // ������� �������� ������������ ����������� �����
                        if (typeof tg.expand === 'function') {
                            tg.expand();
                            console.log('Telegram WebApp expanded');
                        }
                        
                        // �������������: ������������� ����� ���� �����
                        // if (typeof tg.requestFullscreen === 'function') {
                        //     tg.requestFullscreen();
                        // }
                    } catch (error) {
                        console.warn('Error expanding Telegram WebApp:', error);
                    }
                    
                    // 4. ��������� ������ ����� �������� Telegram
                    setTimeout(updateCanvasSize, 200);
                }, 100);
            }
            
            // ========== ������������ UNITY ==========
            var buildUrl = "Build";
            var config = {
                dataUrl: buildUrl + "/WebGL_Build.data",
                frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
                codeUrl: buildUrl + "/WebGL_Build.wasm",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "PheoniX Tech",
                productName: "Altiragame",
                productVersion: "0.0.0.0",
                showBanner: unityShowBanner,
                matchWebGLToCanvasSize: true, // �����: true ��� ����������� ���������������
                devicePixelRatio: window.devicePixelRatio || 1
            };

            // ������� ��� ������ ��������� �� �������
            function unityShowBanner(msg, type) {
                function updateBannerVisibility() {
                    if (warningBanner) {
                        warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                    }
                }
                var warningBanner = document.querySelector("#unity-warning");
                if (!warningBanner) return;
                
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') {
                    div.style = 'background: red; padding: 10px;';
                } else {
                    if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                    setTimeout(function() {
                        warningBanner.removeChild(div);
                        updateBannerVisibility();
                    }, 5000);
                }
                updateBannerVisibility();
            }

            // ������� ��� ��������� ������� canvas
            function updateCanvasSize() {
                var canvas = document.querySelector("#unity-canvas");
                var container = document.querySelector("#unity-container");
                if (!canvas || !container) return;
                
                var containerWidth = container.clientWidth;
                var containerHeight = container.clientHeight;
                
                // ����������� ������ 9:16 (������������ ����)
                var targetRatio = 9 / 16;
                var currentRatio = containerWidth / containerHeight;
                
                var newWidth, newHeight;
                
                if (currentRatio > targetRatio) {
                    // ��������� ������� ������� - ������������ �� ������
                    newHeight = containerHeight;
                    newWidth = containerHeight * targetRatio;
                } else {
                    // ��������� ������� ����� - ������������ �� ������
                    newWidth = containerWidth;
                    newHeight = containerWidth / targetRatio;
                }
                
                // ��������� �������
                canvas.style.width = newWidth + "px";
                canvas.style.height = newHeight + "px";
                
                // ��������� ���������� ������� ��� Unity
                var pixelRatio = window.devicePixelRatio || 1;
                canvas.width = Math.floor(newWidth * pixelRatio);
                canvas.height = Math.floor(newHeight * pixelRatio);
                
                console.log('Canvas updated:', newWidth + 'x' + newHeight, 'Pixel ratio:', pixelRatio);
            }

            // ========== �������� UNITY ==========
            var canvas = document.querySelector("#unity-canvas");
            var container = document.querySelector("#unity-container");
            var warningBanner = document.querySelector("#unity-warning");
            
            // ���������� ��������� ����������
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                
                // �������������� ��������� ��� iOS
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    // ��� iOS � ������������ ���������
                    document.body.style.paddingTop = 'env(safe-area-inset-top)';
                    document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
                    
                    // ������������� ��������� ������ �����
                    document.documentElement.style.height = '100%';
                    document.documentElement.style.overflow = 'hidden';
                }
            }

            // ���������� ����� ��������
            var loadingBar = document.querySelector("#unity-loading-bar");
            if (loadingBar) loadingBar.style.display = "block";

            // ��������� Unity
            if (typeof createUnityInstance !== "undefined") {
                createUnityInstance(canvas, config, function(progress) {
                    // ��������� ��������-���
                    var progressBarFull = document.querySelector("#unity-progress-bar-full");
                    if (progressBarFull) {
                        progressBarFull.style.width = (100 * progress) + "%";
                    }
                }).then(function(unityInstance) {
                    // �������� ����� ��������
                    var loadingBar = document.querySelector("#unity-loading-bar");
                    if (loadingBar) loadingBar.style.display = "none";
                    
                    // ��������� �������������� ������ ������ Unity
                    var fullscreenButton = document.querySelector("#unity-fullscreen-button");
                    if (fullscreenButton && unityInstance.SetFullscreen) {
                        fullscreenButton.onclick = function() {
                            unityInstance.SetFullscreen(1);
                        };
                    }
                    
                    // ������������� ��������� ������
                    updateCanvasSize();
                    
                    // ����������� ��������� �������
                    window.addEventListener('resize', updateCanvasSize);
                    window.addEventListener('orientationchange', function() {
                        setTimeout(updateCanvasSize, 300);
                    });
                    
                }).catch(function(message) {
                    // ��������� ������
                    console.error("Failed to load Unity game:", message);
                    var loadingBar = document.querySelector("#unity-loading-bar");
                    if (loadingBar) loadingBar.style.display = "none";
                    unityShowBanner("Failed to load game: " + message, "error");
                });
            } else {
                // ���� ��������� �� �����������
                unityShowBanner("Failed to load Unity WebGL player.", "error");
                var loadingBar = document.querySelector("#unity-loading-bar");
                if (loadingBar) loadingBar.style.display = "none";
            }
        });
    </script>
</body>
</html>
