<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Altiragame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #unity-container {
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }
        
        #unity-canvas {
            background: #000;
            display: block;
        }
        
        /* Debug panel - ENGLISH ONLY */
        #debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 9999;
            border-radius: 5px;
            border: 1px solid #333;
            display: none;
            line-height: 1.4;
        }
        
        #debug-panel.active { display: block; }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debug-panel">
        <div>DEBUG INFO:</div>
        <div id="debug-content">Loading...</div>
    </div>
    
    <!-- Telegram WebApp Init -->
    <script>
        (function() {
            if (window.Telegram && Telegram.WebApp) {
                window.isTelegram = true;
                const tg = Telegram.WebApp;
                tg.expand();
                setTimeout(() => tg.setViewportHeight(1.0), 100);
            } else {
                window.isTelegram = false;
            }
        })();
    </script>
    
    <!-- Game Container -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1080 height=1920 tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>
    
    <!-- Unity Loader -->
    <script src="Build/WebGL_Build.loader.js"></script>
    
    <script>
        // ========== CONFIG ==========
        var buildUrl = "Build";
        var config = {
            dataUrl: buildUrl + "/WebGL_Build.data",
            frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
            codeUrl: buildUrl + "/WebGL_Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "PheoniX Tech",
            productName: "Altiragame",
            productVersion: "0.0.0.0",
            showBanner: unityShowBanner,
            matchWebGLToCanvasSize: false
        };
        
        // ========== GLOBALS ==========
        var unityInstance = null;
        var debugActive = false;
        var currentScale = 1.0;
        var minWidth = 500; // Minimum width for readability
        
        // ========== DEBUG ==========
        function toggleDebug() {
            debugActive = !debugActive;
            var panel = document.getElementById('debug-panel');
            panel.classList.toggle('active', debugActive);
            if (debugActive) updateDebug();
        }
        
        function updateDebug() {
            if (!debugActive) return;
            
            var container = document.getElementById('unity-container');
            var canvas = document.getElementById('unity-canvas');
            var content = document.getElementById('debug-content');
            
            content.innerHTML = 
                'Container: ' + container.clientWidth + ' ? ' + container.clientHeight + '<br>' +
                'Canvas: ' + canvas.clientWidth + ' ? ' + canvas.clientHeight + '<br>' +
                'Window: ' + window.innerWidth + ' ? ' + window.innerHeight + '<br>' +
                'Scale: ?' + currentScale.toFixed(2) + '<br>' +
                'Aspect: ' + (container.clientWidth/container.clientHeight).toFixed(3) + '<br>' +
                'DPR: ' + (window.devicePixelRatio || 1) + '<br>' +
                'Telegram: ' + (window.isTelegram ? 'Yes' : 'No');
        }
        
        // ========== SCALING FOR TELEGRAM ==========
        function applyScaling() {
            if (!window.isTelegram) return false;
            
            var container = document.getElementById('unity-container');
            var containerWidth = container.clientWidth;
            
            // If Telegram gives us less than minWidth, scale up
            if (containerWidth < minWidth) {
                currentScale = minWidth / containerWidth;
                
                // Limit scaling
                if (currentScale > 1.8) currentScale = 1.8;
                if (currentScale < 1.1) currentScale = 1.1;
                
                // Apply scale
                container.style.transform = 'scale(' + currentScale + ')';
                container.style.transformOrigin = 'center center';
                
                // Center the scaled content
                var scaledWidth = containerWidth * currentScale;
                var widthDiff = (scaledWidth - containerWidth) / 2;
                container.style.marginLeft = '-' + widthDiff + 'px';
                
                console.log('Telegram scaling applied: ' + currentScale.toFixed(2) + 'x');
                return true;
            }
            
            // Reset if no scaling needed
            if (currentScale !== 1.0) {
                currentScale = 1.0;
                container.style.transform = 'none';
                container.style.marginLeft = '0';
            }
            return false;
        }
        
        // ========== UPDATE CANVAS SIZE ==========
        function updateCanvasSize() {
            var canvas = document.getElementById('unity-canvas');
            var container = document.getElementById('unity-container');
            
            // Apply Telegram scaling first
            var isScaled = applyScaling();
            
            // Get actual container dimensions
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;
            var targetRatio = 9 / 16;
            
            var newWidth, newHeight;
            
            if (isScaled) {
                // Use scaled dimensions
                newWidth = containerWidth * currentScale;
                newHeight = newWidth / targetRatio;
            } else {
                // Standard aspect ratio calculation
                var currentRatio = containerWidth / containerHeight;
                
                if (currentRatio > targetRatio) {
                    newHeight = containerHeight;
                    newWidth = containerHeight * targetRatio;
                } else {
                    newWidth = containerWidth;
                    newHeight = containerWidth / targetRatio;
                }
            }
            
            // Set canvas dimensions
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            
            // Update WebGL internal size
            var dpr = window.devicePixelRatio || 1;
            canvas.width = Math.floor(newWidth * dpr);
            canvas.height = Math.floor(newHeight * dpr);
            
            // Update debug info
            updateDebug();
        }
        
        // ========== BANNER FUNCTION ==========
        function unityShowBanner(msg, type) {
            var banner = document.getElementById('unity-warning');
            if (!banner) return;
            
            function updateBanner() {
                banner.style.display = banner.children.length ? 'block' : 'none';
            }
            
            var div = document.createElement('div');
            div.innerHTML = msg;
            banner.appendChild(div);
            
            if (type === 'error') {
                div.style.cssText = 'background: #d32f2f; color: white; padding: 10px; margin: 5px; border-radius: 4px;';
            } else {
                div.style.cssText = 'background: #ffa000; color: black; padding: 10px; margin: 5px; border-radius: 4px;';
                setTimeout(function() {
                    if (div.parentNode === banner) {
                        banner.removeChild(div);
                        updateBanner();
                    }
                }, 5000);
            }
            
            updateBanner();
        }
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            var canvas = document.getElementById('unity-canvas');
            var container = document.getElementById('unity-container');
            
            // Detect mobile
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                container.className = 'unity-mobile';
                canvas.className = 'unity-mobile';
            }
            
            // Debug hotkey (Ctrl+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    toggleDebug();
                    e.preventDefault();
                }
            });
            
            // Show loading screen
            document.getElementById('unity-loading-bar').style.display = 'block';
            
            // Load Unity
            if (typeof createUnityInstance !== 'undefined') {
                createUnityInstance(canvas, config, function(progress) {
                    var bar = document.getElementById('unity-progress-bar-full');
                    if (bar) bar.style.width = (100 * progress) + '%';
                }).then(function(instance) {
                    unityInstance = instance;
                    
                    // Hide loading
                    document.getElementById('unity-loading-bar').style.display = 'none';
                    
                    // Set initial size
                    updateCanvasSize();
                    
                    // Special handling for Telegram
                    if (window.isTelegram) {
                        setTimeout(function() {
                            updateCanvasSize();
                            setTimeout(updateCanvasSize, 300);
                        }, 200);
                    }
                    
                    // Handle resize
                    var resizeTimer;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(updateCanvasSize, 100);
                    });
                    
                }).catch(function(error) {
                    console.error('Unity load error:', error);
                    unityShowBanner('Load error: ' + error, 'error');
                    document.getElementById('unity-loading-bar').style.display = 'none';
                });
            } else {
                unityShowBanner('Unity loader not found', 'error');
                document.getElementById('unity-loading-bar').style.display = 'none';
            }
        });
    </script>
</body>
</html>
