<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #unity-container {
            position: relative;
            background: #000;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        #unity-canvas {
            background: #000;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .unity-mobile #unity-canvas {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
        
        /* ��������������� ������ */
        #telegram-debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 9999;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- ��������������� ������ (Ctrl+D ��� ������/�������) -->
    <div id="telegram-debug"></div>
    
    <script>
        // ���������, ��� �� ������ Telegram WebApp
        if (window.Telegram && Telegram.WebApp) {
            const tg = Telegram.WebApp;
            tg.expand();
            tg.setViewportHeight(0.95);
            tg.disableVerticalSwipes = true;
            console.log('Telegram WebApp initialized');
            
            // ��������� ������ ��� �����������
            window.TelegramWebApp = tg;
        }
    </script>
    
    <!-- ��������� ��� ���� -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1080 height=1920 tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <!-- ���������� ������ ���������� -->
    <script src="Build/WebGL_Build.loader.js"></script>

    <script>
        // ������������ Unity
        var buildUrl = "Build";
        var config = {
            dataUrl: buildUrl + "/WebGL_Build.data",
            frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
            codeUrl: buildUrl + "/WebGL_Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "PheoniX Tech",
            productName: "Altiragame",
            productVersion: "0.0.0.0",
            showBanner: unityShowBanner,
            matchWebGLToCanvasSize: false
        };

        // ���������� ����������
        var unityInstance = null;
        var debugEnabled = false;
        var currentScale = 1.0;

        // ������� ��� ������ ���������
        function unityShowBanner(msg, type) {
            var warningBanner = document.querySelector("#unity-warning");
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') {
                div.style = 'background: red; padding: 10px;';
            } else {
                if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                setTimeout(function() {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        // ������� �����������
        function updateDebugInfo() {
            if (!debugEnabled) return;
            
            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var debugPanel = document.querySelector("#telegram-debug");
            
            var info = `
                ���������: ${container.clientWidth} ? ${container.clientHeight}<br>
                Canvas: ${canvas.clientWidth} ? ${canvas.clientHeight}<br>
                ����: ${window.innerWidth} ? ${window.innerHeight}<br>
                �������: ${currentScale.toFixed(2)}<br>
                �����������: ${(container.clientWidth/container.clientHeight).toFixed(3)}<br>
                DPR: ${window.devicePixelRatio}
            `;
            
            if (window.TelegramWebApp) {
                info += `<br>Telegram: ${window.TelegramWebApp.viewportHeight}vh`;
            }
            
            debugPanel.innerHTML = info;
        }

        // ����� ��������������� ��� Telegram
        function applySmartScaling() {
            var container = document.querySelector("#unity-container");
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;
            
            // ���������� ����������� ���������� ������
            var minComfortWidth = 380;
            var targetRatio = 9 / 16;
            
            // ������������ ��������� ������ ��� ����������� 9:16
            var idealWidth = containerHeight * targetRatio;
            
            // ���� �������� ������ ������� ���������
            if (containerWidth < minComfortWidth) {
                // ������������ ������� ��� ���������� ����������� ���������� ������
                currentScale = minComfortWidth / containerWidth;
                
                // ������������ ������������ �������
                if (currentScale > 1.5) currentScale = 1.5;
                if (currentScale < 1.0) currentScale = 1.0;
                
                // ��������� ���������������
                container.style.transform = `scale(${currentScale})`;
                container.style.transformOrigin = 'center center';
                
                // ������������ �������, ����� ������� ��������� �� ������
                var scaledHeight = containerHeight * currentScale;
                var heightDiff = (scaledHeight - containerHeight) / 2;
                container.style.marginTop = `-${heightDiff}px`;
                
                return true;
            } else {
                // ���������� �������, ���� ������ ����������
                if (currentScale !== 1.0) {
                    currentScale = 1.0;
                    container.style.transform = 'none';
                    container.style.marginTop = '0';
                }
                return false;
            }
        }

        // �������� ������� ���������� ��������
        function updateCanvasSize() {
            var canvas = document.querySelector("#unity-canvas");
            var container = document.querySelector("#unity-container");
            
            // ��������� ����� ���������������
            var isScaled = applySmartScaling();
            
            // �������� ����������� ������� ���������� (��� � ������ ��������)
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;
            var targetRatio = 9 / 16;
            
            // ������������ ������� � ������ ���������������
            var newWidth, newHeight;
            
            if (isScaled) {
                // ���� ��������� ���������������, ���������� ����������� ������
                newWidth = containerWidth;
                newHeight = containerWidth / targetRatio;
            } else {
                // ����������� ������ ���������
                var currentRatio = containerWidth / containerHeight;
                
                if (currentRatio > targetRatio) {
                    newHeight = containerHeight;
                    newWidth = containerHeight * targetRatio;
                } else {
                    newWidth = containerWidth;
                    newHeight = containerWidth / targetRatio;
                }
            }
            
            // ��������� ����� �������
            canvas.style.width = newWidth + "px";
            canvas.style.height = newHeight + "px";
            
            // ��������� ���������� ������� canvas
            canvas.width = Math.floor(newWidth * window.devicePixelRatio);
            canvas.height = Math.floor(newHeight * window.devicePixelRatio);
            
            // ��������� �����������
            updateDebugInfo();
            
            // ���������� Unity � ����� ��������
            if (unityInstance) {
                try {
                    unityInstance.SendMessage('CanvasScalerForWebGL', 'OnWebGLResize', 
                        canvas.width + ',' + canvas.height);
                } catch(e) {
                    // ����������, ���� ���������� �� ��������
                }
            }
        }

        // �������������
        document.addEventListener('DOMContentLoaded', function() {
            var canvas = document.querySelector("#unity-canvas");
            var container = document.querySelector("#unity-container");
            
            // ���������� ��� ����������
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                container.className = "unity-mobile";
                canvas.className = "unity-mobile";
                
                // �������������� viewport ��� ���������
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.head.appendChild(meta);
            }
            
            // ��������� ����������� (Ctrl+D ��� ���������/����������)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    debugEnabled = !debugEnabled;
                    var debugPanel = document.querySelector("#telegram-debug");
                    debugPanel.style.display = debugEnabled ? 'block' : 'none';
                    updateDebugInfo();
                    e.preventDefault();
                }
            });
            
            // ���������� ����� ��������
            document.querySelector("#unity-loading-bar").style.display = "block";
            
            // ��������� Unity
            if (typeof createUnityInstance !== "undefined") {
                createUnityInstance(canvas, config, function(progress) {
                    var progressBarFull = document.querySelector("#unity-progress-bar-full");
                    if (progressBarFull) {
                        progressBarFull.style.width = 100 * progress + "%";
                    }
                }).then(function(instance) {
                    unityInstance = instance;
                    document.querySelector("#unity-loading-bar").style.display = "none";
                    
                    // ��������� ��������� ��������
                    updateCanvasSize();
                    
                    // ����������� ��������� ��������
                    var resizeTimer;
                    window.addEventListener('resize', function() {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(updateCanvasSize, 100);
                    });
                    
                    window.addEventListener('orientationchange', function() {
                        setTimeout(updateCanvasSize, 300);
                    });
                    
                }).catch(function(message) {
                    alert("������ ��������: " + message);
                    document.querySelector("#unity-loading-bar").style.display = "none";
                });
            } else {
                unityShowBanner("������ �������� Unity WebGL. ��������� ��������� ��������.", "error");
                document.querySelector("#unity-loading-bar").style.display = "none";
            }
        });
    </script>
</body>
</html>
