<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <!-- ���������� ������ ��� ��� ��������� -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #231F20;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #unity-container {
            position: relative;
            background: #000000;
            max-width: calc(100vh * (9 / 16));
            height: 100vh;
            width: 100%;
        }
        #unity-canvas {
            background: #000000;
            width: 100%;
            height: 100%;
            display: block;
        }
        @media (max-aspect-ratio: 9/16) {
            #unity-container {
                max-width: 100vw;
                height: calc(100vw * (16 / 9));
            }
        }
    </style>
    <!-- ���������� Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- ��������� ��� ���� -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1080 height=1920 tabindex="-1"></canvas>
        <!-- ����� �������� -->
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <!-- ������ ��� ������ -->
        <div id="unity-warning"></div>
    </div>

    <!-- ���������� ������ ���������� Unity -->
    <script src="Build/WebGL_Build.loader.js"></script>

    <script>
        // ========== ��������� TELEGRAM MINI APP ==========
        // ������������� ����� ������ �������� ��������
        window.addEventListener('load', function() {
            if (window.Telegram && Telegram.WebApp) {
                const tg = Telegram.WebApp;
                
                // 1. ������������ �������������
                tg.ready();
                console.log('Telegram WebApp initialized.');
                
                // 2. ��������� �������������� ������ (����������� �����)
                try {
                    // ��������� ��������� ������ API (Bot API 8.0+)
                    if (typeof tg.requestFullscreen === 'function') {
                        tg.requestFullscreen();
                        console.log('Fullscreen mode requested via requestFullscreen()');
                    } else {
                        // �������� ������� ��� ������ ������
                        tg.expand();
                        console.log('Fallback: window expanded via expand()');
                    }
                } catch (error) {
                    console.error('Error setting fullscreen:', error);
                    // ������� ������� �� ������ ������
                    if (typeof tg.expand === 'function') {
                        tg.expand();
                    }
                }
                
                // 3. ��������� ������ ��� ������� ����������
                if (typeof tg.disableVerticalSwipes === 'function') {
                    tg.disableVerticalSwipes();
                }
                
                // 4. ��������� ���� (�����������)
                // tg.setHeaderColor(tg.themeParams.bg_color || '#000000');
                // tg.setBackgroundColor(tg.themeParams.bg_color || '#231F20');
            } else {
                console.warn('Not running in Telegram WebApp. Running in standalone mode.');
            }
        });
        
        // ========== ������������ UNITY ==========
        var buildUrl = "Build";
        var config = {
            dataUrl: buildUrl + "/WebGL_Build.data",
            frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
            codeUrl: buildUrl + "/WebGL_Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "PheoniX Tech",
            productName: "Altiragame",
            productVersion: "0.0.0.0",
            showBanner: unityShowBanner,
            matchWebGLToCanvasSize: false
        };

        // ������� ��� ������ ��������� �� �������/���������������
        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                if (warningBanner) {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
            }
            var warningBanner = document.querySelector("#unity-warning");
            if (!warningBanner) return;
            
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') {
                div.style = 'background: red; padding: 10px;';
            } else {
                if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                setTimeout(function() {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        // ������� ��� ��������� ������� canvas ��� ����������� 9:16
        function updateCanvasSize() {
            var canvas = document.querySelector("#unity-canvas");
            var container = document.querySelector("#unity-container");
            if (!canvas || !container) return;
            
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;
            
            // ������� ����������� ������ (������������ iPhone)
            var targetRatio = 9 / 16;
            var currentRatio = containerWidth / containerHeight;
            
            var newWidth, newHeight;
            
            if (currentRatio > targetRatio) {
                // ��������� ������� ������� - ������������ �� ������
                newHeight = containerHeight;
                newWidth = containerHeight * targetRatio;
            } else {
                // ��������� ������� ����� - ������������ �� ������
                newWidth = containerWidth;
                newHeight = containerWidth / targetRatio;
            }
            
            // ��������� ����� �������
            canvas.style.width = newWidth + "px";
            canvas.style.height = newHeight + "px";
            
            // ��������� ���������� ������� canvas ��� ������
            var pixelRatio = window.devicePixelRatio || 1;
            canvas.width = Math.floor(newWidth * pixelRatio);
            canvas.height = Math.floor(newHeight * pixelRatio);
        }

        // ========== ������������� UNITY ==========
        document.addEventListener('DOMContentLoaded', function() {
            var canvas = document.querySelector("#unity-canvas");
            var container = document.querySelector("#unity-container");
            var warningBanner = document.querySelector("#unity-warning");
            
            // ���������, ��������� �� ��� ����������
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                // ��������� �����: ����������� �� ���� �����
                if (container) container.className = "unity-mobile";
                if (canvas) canvas.className = "unity-mobile";
                
                // ������� ����-��� viewport ��� ��������� ���������
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
                document.getElementsByTagName('head')[0].appendChild(meta);
            } else if (canvas) {
                // ���������� �����: ������ ������������� �������
                canvas.style.width = "1080px";
                canvas.style.height = "1920px";
            }

            // ���������� ����� ��������
            var loadingBar = document.querySelector("#unity-loading-bar");
            if (loadingBar) loadingBar.style.display = "block";

            // ��������� � ��������� Unity
            if (typeof createUnityInstance !== "undefined") {
                createUnityInstance(canvas, config, function(progress) {
                    // ��������� ��������-���
                    var progressBarFull = document.querySelector("#unity-progress-bar-full");
                    if (progressBarFull) {
                        progressBarFull.style.width = (100 * progress) + "%";
                    }
                }).then(function(unityInstance) {
                    // �������� ����� �������� ����� �������� ��������
                    var loadingBar = document.querySelector("#unity-loading-bar");
                    if (loadingBar) loadingBar.style.display = "none";
                    
                    // ����������� ������ �������������� ������
                    var fullscreenButton = document.querySelector("#unity-fullscreen-button");
                    if (fullscreenButton && unityInstance.SetFullscreen) {
                        fullscreenButton.onclick = function() {
                            unityInstance.SetFullscreen(1);
                        };
                    }
                    
                    // ������������� ��������� ������ canvas
                    updateCanvasSize();
                    
                    // ��������� ������ ��� ��������� ����
                    window.addEventListener('resize', updateCanvasSize);
                    window.addEventListener('orientationchange', function() {
                        setTimeout(updateCanvasSize, 100);
                    });
                    
                }).catch(function(message) {
                    // ��������� ������ ��������
                    console.error("Failed to load Unity game:", message);
                    var loadingBar = document.querySelector("#unity-loading-bar");
                    if (loadingBar) loadingBar.style.display = "none";
                    unityShowBanner("Failed to load game: " + message, "error");
                });
            } else {
                // ���� ��������� Unity �� �����������
                unityShowBanner("Failed to load Unity WebGL player. Please check your browser settings.", "error");
                var loadingBar = document.querySelector("#unity-loading-bar");
                if (loadingBar) loadingBar.style.display = "none";
            }
        });
    </script>
</body>
</html>
