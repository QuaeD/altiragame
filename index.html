<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }
        
        #unity-container {
            position: relative;
            background: #000000;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease-out;
        }
        
        #unity-canvas {
            background: #000000;
            display: block;
        }
        
        /* ��������������� ������ */
        #unity-debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: #4CAF50;
            padding: 12px 15px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            z-index: 10000;
            border-radius: 6px;
            border: 1px solid #333;
            display: none;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
            word-break: break-all;
        }
        
        #unity-debug strong {
            color: #FF9800;
        }
        
        /* ������ �� ��������� */
        .unity-mobile #unity-debug {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ��������������� ������ -->
    <div id="unity-debug">
        <div><strong>�������� �����</strong></div>
        <div id="debug-info">��������...</div>
    </div>
    
    <!-- ������������� Telegram WebApp -->
    <script>
        (function() {
            // ���������, ��� �� ������ Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                try {
                    const tg = Telegram.WebApp;
                    
                    // ��������� ��������� ��� �����������
                    window.telegramApp = tg;
                    
                    // ��������� ����
                    tg.expand();
                    
                    // ������� ������ ������ ���������� ����
                    setTimeout(() => {
                        tg.setViewportHeight(1.0); // 100% ������
                        tg.enableClosingConfirmation(); // ��������� ��������� ��������
                    }, 100);
                    
                    console.log('Telegram WebApp ���������������');
                    
                    // ��������� ����� ��� Telegram
                    document.body.classList.add('telegram-webapp');
                    
                } catch(e) {
                    console.error('������ Telegram WebApp:', e);
                }
            }
        })();
    </script>
    
    <!-- ��������� ���� -->
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1080 height=1920 tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>
    
    <!-- ��������� Unity -->
    <script src="Build/WebGL_Build.loader.js"></script>
    
    <script>
        // ================= ������������ UNITY =================
        var buildUrl = "Build";
        var config = {
            dataUrl: buildUrl + "/WebGL_Build.data",
            frameworkUrl: buildUrl + "/WebGL_Build.framework.js",
            codeUrl: buildUrl + "/WebGL_Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "PheoniX Tech",
            productName: "Altiragame",
            productVersion: "0.0.0.0",
            showBanner: unityShowBanner,
            matchWebGLToCanvasSize: false
        };
        
        // ================= ���������� ���������� =================
        var unityInstance = null;
        var debugMode = false;
        var currentScale = 1.0;
        var isTelegram = !!window.telegramApp;
        var minGameWidth = 500; // ����������� ������ ��� ����������
        
        // ================= ����������� =================
        function toggleDebug() {
            debugMode = !debugMode;
            var debugPanel = document.getElementById('unity-debug');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            if (debugMode) updateDebugInfo();
        }
        
        function updateDebugInfo() {
            if (!debugMode) return;
            
            var container = document.getElementById('unity-container');
            var canvas = document.getElementById('unity-canvas');
            var debugPanel = document.getElementById('debug-info');
            
            var info = `
                <div>���������: ${container.clientWidth} ? ${container.clientHeight}</div>
                <div>Canvas: ${canvas.clientWidth} ? ${canvas.clientHeight}</div>
                <div>����: ${window.innerWidth} ? ${window.innerHeight}</div>
                <div>�������: ?${currentScale.toFixed(2)}</div>
                <div>�����������: ${(container.clientWidth/container.clientHeight).toFixed(3)}</div>
                <div>DPR: ${window.devicePixelRatio}</div>
                <div>Telegram: ${isTelegram ? '��' : '���'}</div>
            `;
            
            debugPanel.innerHTML = info;
        }
        
        // ================= ��������������� =================
        function applyTelegramScaling() {
            if (!isTelegram) return false;
            
            var container = document.getElementById('unity-container');
            var containerWidth = container.clientWidth;
            
            // Telegram ��� 384px, ��� ����� ������� 500px
            if (containerWidth < minGameWidth) {
                // ������������ �������
                currentScale = minGameWidth / containerWidth;
                
                // ������������ ������� (�������� 1.8x)
                if (currentScale > 1.8) currentScale = 1.8;
                if (currentScale < 1.1) currentScale = 1.1;
                
                // ��������� ���������������
                container.style.transform = `scale(${currentScale})`;
                container.style.transformOrigin = 'center center';
                
                // ������������ ������� ��� �������������
                var scaledWidth = containerWidth * currentScale;
                var widthDiff = (scaledWidth - containerWidth) / 2;
                container.style.marginLeft = `-${widthDiff}px`;
                
                console.log(`Telegram scaling: ${containerWidth}px > ${Math.round(scaledWidth)}px (?${currentScale.toFixed(2)})`);
                return true;
            }
            
            // ���������� ������� ���� �� �����
            if (currentScale !== 1.0) {
                currentScale = 1.0;
                container.style.transform = 'none';
                container.style.marginLeft = '0';
            }
            return false;
        }
        
        // ================= ���������� �������� CANVAS =================
        function updateCanvasSize() {
            var canvas = document.getElementById('unity-canvas');
            var container = document.getElementById('unity-container');
            
            // ��������� ��������������� ��� Telegram
            var isScaled = applyTelegramScaling();
            
            // �������� ����������� �������
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;
            var targetRatio = 9 / 16;
            
            var newWidth, newHeight;
            
            if (isScaled) {
                // ���� �������������� ��� Telegram, ���������� ����������� �������
                newWidth = containerWidth * currentScale;
                newHeight = newWidth / targetRatio;
            } else {
                // ����������� ������ � ����������� ���������
                var currentRatio = containerWidth / containerHeight;
                
                if (currentRatio > targetRatio) {
                    // ������� ������ - ������������ �� ������
                    newHeight = containerHeight;
                    newWidth = containerHeight * targetRatio;
                } else {
                    // ������� ���� - ������������ �� ������
                    newWidth = containerWidth;
                    newHeight = containerWidth / targetRatio;
                }
            }
            
            // ������������� ������� Canvas
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            
            // ��������� ���������� ������� ��� WebGL
            var dpr = window.devicePixelRatio || 1;
            canvas.width = Math.floor(newWidth * dpr);
            canvas.height = Math.floor(newHeight * dpr);
            
            // �����������
            updateDebugInfo();
            
            // ���������� Unity � ����� ��������
            if (unityInstance) {
                try {
                    unityInstance.SendMessage('GameController', 'OnResolutionChanged', 
                        canvas.width + ',' + canvas.height);
                } catch(e) {
                    // ���������� ���� ��� ������ ������
                }
            }
        }
        
        // ================= ����� �������� =================
        function unityShowBanner(msg, type) {
            var warningBanner = document.getElementById('unity-warning');
            if (!warningBanner) return;
            
            function updateVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            
            if (type === 'error') {
                div.style.cssText = 'background: #f44336; color: white; padding: 12px; border-radius: 6px; margin: 5px;';
            } else if (type === 'warning') {
                div.style.cssText = 'background: #ff9800; color: black; padding: 12px; border-radius: 6px; margin: 5px;';
                setTimeout(() => {
                    warningBanner.removeChild(div);
                    updateVisibility();
                }, 5000);
            }
            
            updateVisibility();
        }
        
        // ================= ������������� =================
        document.addEventListener('DOMContentLoaded', function() {
            var canvas = document.getElementById('unity-canvas');
            var container = document.getElementById('unity-container');
            
            // ���������� ��������� ����������
            var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                container.className = 'unity-mobile';
                canvas.className = 'unity-mobile';
                
                // ����������� ��� ���������
                var meta = document.createElement('meta');
                meta.name = 'viewport';
                meta.content = 'width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
                document.head.appendChild(meta);
            }
            
            // ������� ������� ��� ������ (Ctrl+Shift+D)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    toggleDebug();
                    e.preventDefault();
                }
            });
            
            // ���������� ����� ��������
            document.getElementById('unity-loading-bar').style.display = 'block';
            
            // �������� Unity
            if (typeof createUnityInstance !== 'undefined') {
                createUnityInstance(canvas, config, function(progress) {
                    var progressBar = document.getElementById('unity-progress-bar-full');
                    if (progressBar) {
                        progressBar.style.width = (100 * progress) + '%';
                    }
                }).then(function(instance) {
                    unityInstance = instance;
                    
                    // �������� ��������
                    document.getElementById('unity-loading-bar').style.display = 'none';
                    
                    // ��������� ������ �������������� ������
                    var fullscreenBtn = document.getElementById('unity-fullscreen-button');
                    if (fullscreenBtn) {
                        fullscreenBtn.onclick = function() {
                            unityInstance.SetFullscreen(1);
                        };
                    }
                    
                    // ��������� ��������� ��������
                    updateCanvasSize();
                    
                    // ��������� ��������� ��� Telegram
                    if (isTelegram) {
                        setTimeout(function() {
                            updateCanvasSize();
                            // ������������� ��������� ��� ��� ����� 500��
                            setTimeout(updateCanvasSize, 500);
                        }, 200);
                    }
                    
                    // ����������� ��������� ��������
                    var resizeTimer;
                    function handleResize() {
                        clearTimeout(resizeTimer);
                        resizeTimer = setTimeout(updateCanvasSize, 150);
                    }
                    
                    window.addEventListener('resize', handleResize);
                    window.addEventListener('orientationchange', function() {
                        setTimeout(updateCanvasSize, 300);
                    });
                    
                }).catch(function(error) {
                    console.error('Unity �������� ������:', error);
                    unityShowBanner('������ �������� ����: ' + error, 'error');
                    document.getElementById('unity-loading-bar').style.display = 'none';
                });
            } else {
                unityShowBanner('������: Unity WebGL ��������� �� ������', 'error');
                document.getElementById('unity-loading-bar').style.display = 'none';
            }
        });
        
        // ������������� �������� ����� ���� � URL ���� ��������
        if (window.location.search.includes('debug=1')) {
            setTimeout(toggleDebug, 1000);
        }
    </script>
</body>
</html>
